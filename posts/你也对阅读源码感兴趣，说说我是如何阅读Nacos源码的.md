# 你也对阅读源码感兴趣，说说我是如何阅读Nacos源码的

### 前言 

最近写了一些列的Nacos源码相关文章，很多朋友都感兴趣的在问：你最近在阅读什么源码，如何阅读源码？今天这篇文章就以Nacos源码阅读来展开聊聊。对阅读源码或技术感兴趣的朋友，也可以添加微信交流（微信号：zhuan2quan）。

在读这篇文章的时候呢，要看你想获得什么了。因为这篇文章亦是在写如何阅读Nacos源码，也是在写如何阅读源码。不要被技术栈所束缚，要提炼属于自己的方法。看你所欲，取你所需。

### 阅读源码的目的

不清楚大家为什么要阅读源码，就聊聊个人阅读源码的目的，或许可以拿来借鉴。

#### 学习底层原理与实现

阅读某一个框架的源码，最重要的目的就是更深入的学习它的底层实现及原理。这里的底层实现和原理相对来说要宏观一些，比如阅读Nacos源码我就是想知道，它是如何实现服务注册、服务发现以及那些服务实例是如何存储的。

像文章《[微服务的灵魂摆渡者——Nacos，来一篇原理全攻略](https://mp.weixin.qq.com/s/BIPdW34VKvp_Ced3nzUVvQ)》便是来源于此类阅读。你也可以像我一样，阅读之后绘制成流程图、架构图、数据结构图，甚至整理成文章等帮助自己学习和理解。


#### 学习优秀的代码设计。

这一项包含的点就太多了，比如架构设计、功能实现理念、优秀代码示范、设计模式、算法等等。凡是能看到的，比较优秀的实践，都可以学习。

以Nacos为例，简单的一个实例注销的入口方法，你能看到多少值得学习的内容？
![nacos](http://www.choupangxia.com/wp-content/uploads/2021/05/read-nacos-01.jpg)
上图是我一眼看过去，代码给我最直观的感受。然后就可以对照自己项目中的代码，思考一下是否能够达到这么高的标准？是否能进行改造？

再看一个Nacos Client中的例子，在Client中调用Server的API时，会涉及到重试机制和多个Server选一个进行注册的逻辑。看看Nacos是如何实现的。

![nacos](http://www.choupangxia.com/wp-content/uploads/2021/05/read-nacos-02.jpg)

暂且不说算法的优劣，看到这里是不是感觉又学到了一种实现？而且你也知道了Nacos Client在调用Server时到底是怎么处理请求重试和异常的。有意思吧。

当然，这个层面还有一些更深入的，比如一致性算法等很多解决方案的内容。

#### 学习知识点的运用

这一项就更细碎更多了。像前面写的《[Nacos中已经有Optional使用案例了，是时候慎重对待这一语法了](https://mp.weixin.qq.com/s/ZjJX2muwDRKFdtYU5UeZPQ)》和
《[Nacos源码中为什么使用了String.intern方法？]( https://mp.weixin.qq.com/s/jC3Gv3Fi0bo0d7rP5ngqpw)》都是在阅读源码时发掘的知识点。

这个层面有一个很好的点大家一定要把握住。那就是你可能看过很多文章在写某个知识点，而且也写了一些简单的实例。但如果你没有实践的机会，或者没在大型项目中运用，看源码中的实现和思考就非常有意思了。

比如Nacos中对String.intern方法的使用，就没你想象中的那么简单。而且深入思考一下，还会发现并不是每个场景都适合，只有在字符串变化不大的情况下才适合缓存到常量池中。

这里再举一个Nacos中对常见知识点的运用，看看咱们思考的维度是否一样。ServiceManager中有下图这么几个成员变量：

![nacos](http://www.choupangxia.com/wp-content/uploads/2021/05/read-nacos-03.jpg)

上面的知识点可能你已经背的滚瓜烂熟了，但你见过怎么用么？你见过怎么结合起来使用吗？怎么支持分布式、高并发的场景吗？

只要你仔细分析一下，阅读一下源码的实现，你就能得到答案，也算是一次实践。

从源码中可学的内容太多了，我这里就不逐一讲解了，后面会逐步形成系列文章的形式把我看到的源码中的技术和思想分享给大家。

### 如何阅读源码

有了阅读源码的目标，下一步就是执行了。这里就分享一些我阅读源码的方法，不一定适合你，但可以参考和改进。这里全部以Nacos为例，后续不再做特殊说明。

#### 代码的下载

开源项目可以直接拉取源代码，Nacos的源代码有两个平台可以获取：GitHub和码云。码云库作为同步，定时更新。这里采用GitHub作为源码来源，说不定啥时候还可以贡献一些代码。

可以直接执行git命令拉取开源库代码：
```
git clone git@github.com:alibaba/nacos.git
```
但个人并不建议这样直接拉取代码，可以从nacos的仓库fork到自己的GitHub账号下。这样既可以保持与主干的同步，又可以方便的修改一些内容。

#### 项目结构

下载完成之后，直接通过IDEA打开项目，待依赖类库引入完毕，可看到如下项目结构：

![nacos](http://www.choupangxia.com/wp-content/uploads/2021/05/read-nacos-04.jpg)
此时可以大概了解一下目录结构，基本都能见名知意。

- address：地址服务相关；
- api：naming和config的api抽取；
- auth：权限控制相关；
- cmdb：支持对接第三方CMDB获取CMDB数据等；
- client：为客户端代码；
- common：共用工具类；
- config：Nacos配置中心的实现；
- consistency：一致性实现；
- console：Nacos控制台相关实现；
- console-uri：控制台UI部分实现；
- core：属性加载，初始化，监听器相关；
- distribution：发布相关；
- example：示例；
- istio：对istio的支持，如k8s等；
- naming：Nacos的核心功能，动态服务发现；

#### 项目的启动与测试

要阅读源码跟踪流程，肯定要先把项目启动起来。由于Nacos是基于Spring Boot来构建的，只需执行对应入口类的main方法即可。

在console项目中，执行Nacos的main方法即可启动项目。Nacos默认启动的是集群模式，研究代码先启动单机模式即可。这里通过在main方法中添加参数指定单机模式：

```
public class Nacos {

    public static void main(String[] args) {

        // 通过环境变量的形式设置单机启动
        System.setProperty(Constants.STANDALONE_MODE_PROPERTY_NAME, "true");
        // 通过环境变量的形式设置关闭权限校验
        System.setProperty("nacos.core.auth.enabled", "false");

        SpringApplication.run(Nacos.class, args);
    }
}
```
程序启动之后，在client项目中的单元测试（test）中可以看到NamingTest和ConfigTest类，直接执行单元测试中的方法即可连接刚启动的Server进行代码跟踪调试了。

此时，关于不同API的操作，也可参看官方文档的说明进行调用验证了，这就不做演示了。

#### 项目流程的梳理

完成了代码的下载和启动之后，那么如何来梳理源代码的业务逻辑呢？很多朋友可能会遇到一些困惑，比如看不懂，或看了就忘了，每次都得重新梳理一遍。

这个种状况在初期阶段很容易出现，也算是正常情况。我的处理方式是，先将fork的代码打一个分支（branch），比如我会打一个comment的分支。在这个分支上，每看到一行代码有点难度的代码或者需要备注的代码，就会在上面添加注释。

关于Nacos本人fork的代码地址https://github.com/secbr/nacos，其中comment分支中在逐步添加注释，对Nacos源码感兴趣的朋友可以看一下。

![nacos](http://www.choupangxia.com/wp-content/uploads/2021/05/read-nacos-05.jpg)

比如上图是client请求服务器进行注册的部分代码逻辑，我会将梳理过的路径通过注释的形式进行描述。这样每次看到就不用再次梳理了。

当对上述逻辑看得多了，也就不会忘记了。就这样逐个逻辑，逐个类的添加注释，当享受梳理流程图或架构图时，只用将注释内容进行提炼和概况即可。

再看一下client注册时，server对应的代码注释：
![nacos](http://www.choupangxia.com/wp-content/uploads/2021/05/read-nacos-06.jpg)

至此，关于阅读源码的核心部分已经完事。剩下的就是逐个业务流程的梳理，逐个技术点的学习。如果遇到无法理解的部分，最好通过debug模式跟踪一下，看看执行到此处时，具体的数据都是什么。

### 小结

个人觉得阅读源码是每个程序员必备的技能，也是站在巨人肩膀上提升自己的必要手段。只有看得更多，才知道什么是更好的写法和实现。当然，每个人现阶段的能力有限，有很多技术点或设计思想当前阶段可能无法看到，但不要紧，你也可以拿我来做个垫背的，毕竟我是计划写一个源码解析系列的。